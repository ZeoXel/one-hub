# 一周交付计划（聚焦“上游密钥二次打包”为用户二级密钥）

## 1. 背景与目标
- **背景**：项目已完整支持多上游中转（Channel）、路由/限流、用户/令牌、计费/充值等核心能力。我们只需配置上游 `base_url + api_key` 即可使用。
- **目标**：基于现有能力，完成“上游密钥二次打包 → 分发二级密钥给用户”的闭环，形成企业管理平台（Admin）与用户服务平台（Portal）的最小可用版本，并上线试运行。

## 2. 最终产出（一周内）
- **双端入口（同后端）**：
  - **Admin**：用户/渠道/价格/用量监控、告警与运营配置。
  - **Portal**：注册登录、充值、查看/管理二级密钥（Token）、用量与示例文档。
- **上游对接**：按模型组配置渠道，健康检查与基础权重路由生效。
- **二级密钥发放**：用户可创建/禁用/重置 Token，设置到期/配额；调用路径直连我方网关，后端转发至上游；用量与扣费准确。
- **基础风控**：全局与每令牌限流开关（复用 `common/limit` 能力），失败率与余额阈值告警打通至少一种通知通道。

## 3. 方案确认
- **二级密钥 = 现有 Token 实体**：
  - 唯一性与防伪：`common/user-token.go` 基于 HMAC+Sqids 生成 59 位签名令牌（AfterCreate 自动生成）。
  - 配额/过期/启禁：`model/token.go` 已具备；精确扣费 `PreConsume`/`PostConsume`；支持“无限额度”。
  - 分组与路由：`Token.Group` → 命中 `ChannelGroup` 模型组路由（`model/balancer.go`）。
  - 限流：复用 `common/limit`（Redis/内存多策略），按“全局/令牌维度”组合。
- **上游接入**：Admin 新增渠道 `Channel`（`base_url`、`key`、`models`、`group`、权重/优先级），健康检查与失败重试（冷却）。
- **计费**：沿用“配额（Quota）/价格（按模型）”核算；Portal 余额充值绑定额度发放。

## 4. 一周里程碑（按天）
- **D1 架构与界面骨架**
  - 双端导航与入口（Admin/Portal），单后端保持不变。
  - Admin：菜单与页面骨架（用户、渠道、价格、用量、通知）。
  - Portal：菜单与页面骨架（账户、充值、我的 Token、用量、接入文档）。
  - 文档：接入方式与示例结构草案。
- **D2 上游与路由最小可用**
  - Admin 配置上游：`base_url`、`api_key`、`models`、`group`、`priority/weight`。
  - 验证 `/v1/chat/completions` 端到端；失败切换（`balancer` 冷却）校验。
  - 健康检查与响应时延回写（`Channel.TestTime/ResponseTime`）。
- **D3 二级密钥（Token）发放闭环**
  - Portal：创建/禁用/删除/重置 Token，设置 `expired_time/remain_quota/unlimited_quota/group`。
  - 用量可视化：按天/模型/令牌维度图表（用户可见）。
  - 示例文档：一键复制 `base_url`、`Authorization: Bearer <token>`、`curl`/SDK 示例。
- **D4 计费与充值联动**
  - 选定一种支付网关（支付宝/微信/Stripe/易支付）：后台配置启用。
  - 充值→额度发放闭环联调；余额/配额变更正确；低额提醒。
  - 价格管理：关闭自动覆盖（转售场景），维护我方售价；核对扣费与报表字段。
- **D5 风控与通知**
  - 全局限流阈值（`GLOBAL_API_RATE_LIMIT` 等），按需启用 Redis 限流。
  - 分组/令牌级限流方案（先分组）；失败熔断与冷却生效。
  - 失败率/上游余额/健康阈值告警；打通至少一种通知通道（邮件/企微/飞书/TG）。
- **D6 联调与文档**
  - 端到端验证：上游切换、扣费准确、Token 生命周期、限流生效、通知触发。
  - 完成上线手册：部署参数、接入指南、运营与风控操作手册、应急预案。
- **D7 上线与验收**
  - 生产部署（MySQL+Redis），Nginx/证书/域名。
  - 验收用例通过，输出回滚与监控清单。

## 5. 详细任务清单（可并行）
- **上游与渠道**
  - [ ] Admin 新建/编辑渠道：`base_url`、`key`、`models`、`group`、`priority/weight`、`test_model`。
  - [ ] 健康检查定时任务与手动测试；失败率看板。
  - [ ] 模型别名/通配符确认与展示（`*` 匹配）。
- **二级密钥（Token）发放**
  - [ ] Portal Token 列表/新增/编辑/删除/禁用/重置（后端 API 复用）。
  - [ ] Token 复制/隐藏显示、备注名校验、到期与配额提示。
  - [ ] Token 维度用量查询与导出（复用日志接口）。
- **计费与充值**
  - [ ] 选择并接通一种支付网关（配置密钥即可）。
  - [ ] 充值→额度发放与日志；低余额提醒。
  - [ ] 价格管理确认：关闭 `auto_price_updates`，以“上游成本+加成”维护。
- **风控与限流**
  - [ ] 全局速率阈值与 Redis 策略开关；高并发压测与参数调优。
  - [ ] 分组/令牌级限流方案（Phase 1 先分组）；失败熔断与冷却（已支持）。
  - [ ] 敏感词/异常突增监控与通知（阈值配置）。
- **监控与通知**
  - [ ] 请求日志检索与看板（错误率/延迟/模型分布）。
  - [ ] 告警通道打通：邮箱/企微/飞书/TG 至少一种。
  - [ ] 月账单/发票（如需，后置开启 `user_invoice_month`）。
- **文档与样例**
  - [ ] 用户接入文档（`base_url`、鉴权、示例 `curl`/SDK、常见错误）。
  - [ ] 管理员操作手册（渠道/价格/风控/告警）。
  - [ ] 变更日志与回滚说明。

## 6. 配置建议（生产）
- **必填**：`user_token_secret`（32+）、`session_secret`、`sql_dsn`、`redis_conn_string`。
- **性能**：高并发开启 `batch_update_enabled: true` 与合适 SQL 连接池；`relay_timeout`/`connect_timeout` 合理设置。
- **路由**：开启 `channel.test_frequency` 定时检查；必要时多上游冗余与权重调整。
- **价格**：`auto_price_updates: false`，避免被系统价覆盖。

## 7. 验收标准（关键用例）
- 用户在 Portal 创建 Token，并用其调用我方网关，获得上游正确返回；
- 用量与余额/配额扣减准确，图表与日志可查询；
- 上游单点故障时流量可切换（权重/冷却生效），错误率稳定；
- 告警在阈值触发并能被运维收到；
- 文档可指导新用户 10 分钟内完成接入与首次调用。

## 8. 风险与缓解
- 上游非完全兼容：优先接 OpenAI 兼容；不兼容列入后续 Provider 定制（不阻塞 MVP）。
- 支付对接进度：先通一种网关，其余延后。
- 高并发性能：提前压测限流与数据库参数，必要时加 Redis 与连接池优化。

---

附：开发期间常用命令（本地）
```bash
# 构建
make

# 启动（示例）
./dist/one-api --config ./config.yaml --port 3000 --log-dir ./logs
```
